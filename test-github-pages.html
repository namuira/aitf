<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>연동 테스트 - GenSpark 에이전트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .agent-icon { background: linear-gradient(135deg, var(--icon-color-1), var(--icon-color-2)); }
        .icon-purple { --icon-color-1: #e0c3fc; --icon-color-2: #9bb5ff; }
        .icon-blue { --icon-color-1: #a8e6cf; --icon-color-2: #88d8ff; }
        .icon-green { --icon-color-1: #c3f0ca; --icon-color-2: #a8e6cf; }
        .icon-red { --icon-color-1: #ffb3ba; --icon-color-2: #ff9aa2; }
    </style>
</head>
<body class="min-h-screen bg-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
            🔗 서버-GitHub Pages 연동 테스트
        </h1>

        <!-- 테스트 설정 -->
        <div class="bg-gray-100 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-semibold mb-4">📡 연결 설정</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">서버 URL</label>
                    <input id="serverUrl" type="text" 
                           class="w-full p-2 border rounded" 
                           value="https://3000-i3ixrw2hugdlbs9khnsxi-6532622b.e2b.dev">
                </div>
                <div class="flex items-end">
                    <button id="testConnection" 
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        🔄 연결 테스트
                    </button>
                </div>
            </div>
            <div id="connectionStatus" class="text-sm"></div>
        </div>

        <!-- 실시간 로그 -->
        <div class="bg-black text-green-400 p-4 rounded-lg mb-8 font-mono text-sm h-40 overflow-y-auto">
            <div id="log"></div>
        </div>

        <!-- 버튼 표시 영역 -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">🎯 로드된 에이전트</h2>
            <div id="agentsContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- 버튼들이 여기에 표시됩니다 -->
            </div>
        </div>

        <!-- 수동 제어 -->
        <div class="bg-yellow-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">🎮 수동 제어</h2>
            <div class="flex flex-wrap gap-3">
                <button id="manualLoad" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    📥 수동 로드
                </button>
                <button id="clearLog" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    🗑️ 로그 지우기
                </button>
                <button id="toggleAutoLoad" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    ⏱️ 자동로드: ON
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        let serverUrl = 'https://3000-i3ixrw2hugdlbs9khnsxi-6532622b.e2b.dev';
        let autoLoadInterval;
        let autoLoadEnabled = true;

        // 로그 함수
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400', 
                success: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 연결 상태 표시
        function updateConnectionStatus(status, type) {
            const statusDiv = document.getElementById('connectionStatus');
            const colors = {
                success: 'text-green-600 bg-green-100',
                error: 'text-red-600 bg-red-100',
                warning: 'text-yellow-600 bg-yellow-100'
            };
            statusDiv.className = `p-2 rounded ${colors[type]}`;
            statusDiv.textContent = status;
        }

        // 기본 에이전트들
        const defaultAgents = [
            { id: 'ai-guide', title: 'AI 가이드', icon: 'fas fa-book-open', color: 'purple' },
            { id: 'ai-site', title: 'AI 사이트', icon: 'fas fa-globe', color: 'blue' },
            { id: 'ai-dev', title: 'AI 개발자', icon: 'fas fa-code', color: 'green' }
        ];

        // 에이전트 로드 함수
        async function loadAgents() {
            try {
                log(`🔍 API 호출 시작: ${serverUrl}/api/buttons`);
                
                const response = await axios.get(`${serverUrl}/api/buttons`, {
                    timeout: 10000,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`✅ API 응답 성공: ${response.data.length}개 버튼 수신`);
                updateConnectionStatus(`연결 성공 - ${response.data.length}개 커스텀 에이전트`, 'success');
                
                // 기본 + 커스텀 에이전트 합치기
                const allAgents = [...defaultAgents];
                response.data.forEach(button => {
                    allAgents.push({
                        id: button.id,
                        title: button.title,
                        icon: button.icon || 'fas fa-star',
                        color: button.color || 'purple',
                        custom: true,
                        type: button.type,
                        url: button.url,
                        htmlContent: button.htmlContent,
                        description: button.description
                    });
                });
                
                renderAgents(allAgents);
                log(`🎨 화면 업데이트 완료: 총 ${allAgents.length}개 에이전트 표시`);
                
                return true;
            } catch (error) {
                log(`❌ 로드 실패: ${error.message}`, 'error');
                updateConnectionStatus(`연결 실패: ${error.message}`, 'error');
                
                // 기본 에이전트만 표시
                renderAgents(defaultAgents);
                log(`🔄 기본 에이전트만 표시: ${defaultAgents.length}개`);
                
                return false;
            }
        }

        // 에이전트 렌더링
        function renderAgents(agents) {
            const container = document.getElementById('agentsContainer');
            container.innerHTML = agents.map(agent => `
                <div class="text-center cursor-pointer group" onclick="handleAgentClick('${agent.id}', '${agent.type || ''}', '${agent.url || ''}')">
                    <div class="agent-icon icon-${agent.color} w-16 h-16 rounded-2xl flex items-center justify-center mb-2 mx-auto transform transition-transform group-hover:scale-110">
                        <i class="${agent.icon} text-xl text-white"></i>
                    </div>
                    <h3 class="text-xs font-medium text-gray-800">${agent.title}</h3>
                    ${agent.custom ? '<span class="text-xs text-purple-600">커스텀</span>' : '<span class="text-xs text-gray-500">기본</span>'}
                </div>
            `).join('');
        }

        // 에이전트 클릭 핸들러
        function handleAgentClick(id, type, url) {
            if (type === 'link' && url) {
                log(`🔗 링크 열기: ${url}`, 'success');
                window.open(url, '_blank');
            } else {
                log(`👆 ${id} 클릭됨 (기본 에이전트)`, 'info');
            }
        }

        // 연결 테스트
        async function testConnection() {
            const urlInput = document.getElementById('serverUrl');
            serverUrl = urlInput.value.trim().replace(/\\/$/, '');
            
            log(`🔧 서버 URL 변경: ${serverUrl}`);
            
            const success = await loadAgents();
            if (success) {
                log('✨ 연결 테스트 성공!', 'success');
            } else {
                log('💥 연결 테스트 실패!', 'error');
            }
        }

        // 자동 로드 토글
        function toggleAutoLoad() {
            const button = document.getElementById('toggleAutoLoad');
            
            if (autoLoadEnabled) {
                clearInterval(autoLoadInterval);
                autoLoadEnabled = false;
                button.textContent = '⏱️ 자동로드: OFF';
                button.className = button.className.replace('bg-purple-600', 'bg-gray-600');
                log('⏸️ 자동 로드 비활성화', 'warning');
            } else {
                startAutoLoad();
                autoLoadEnabled = true;
                button.textContent = '⏱️ 자동로드: ON';
                button.className = button.className.replace('bg-gray-600', 'bg-purple-600');
                log('▶️ 자동 로드 활성화', 'success');
            }
        }

        // 자동 로드 시작
        function startAutoLoad() {
            autoLoadInterval = setInterval(() => {
                log('🔄 자동 새로고침 실행...', 'info');
                loadAgents();
            }, 30000); // 30초마다
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('🗑️ 로그 초기화 완료');
        }

        // 이벤트 리스너
        document.getElementById('testConnection').addEventListener('click', testConnection);
        document.getElementById('manualLoad').addEventListener('click', () => {
            log('🖱️ 수동 로드 실행', 'info');
            loadAgents();
        });
        document.getElementById('clearLog').addEventListener('click', clearLog);
        document.getElementById('toggleAutoLoad').addEventListener('click', toggleAutoLoad);

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 페이지 로딩 완료');
            log(`🎯 대상 서버: ${serverUrl}`);
            
            // 즉시 로드
            loadAgents();
            
            // 자동 로드 시작  
            startAutoLoad();
            
            log('⏱️ 30초마다 자동 새로고침 시작');
        });
    </script>
</body>
</html>